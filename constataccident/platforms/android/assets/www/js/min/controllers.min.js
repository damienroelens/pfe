"use strict";angular.module("constatApp.controllers",[]).controller("mainCtrl",["$scope","$location","Context","User","$rootScope","$swipe","Loading",function(e,t,o,n,a,r,i){$(".overlay").hide(),e.toggleAbout=function(){$(".overlay").is(":visible")?$(".overlay").fadeOut(200):$(".overlay").fadeIn(200)},e.nextButton,e.forNext=function(){o.next()},e.$watch(o.next,function(t){e.nextButton=t}),e.prevButton,e.forPrev=function(){o.prev()},e.$watch(o.prev,function(t){e.prevButton=t}),e.nextView=function(){e.lo="#"+o.nextLoc(),i.unset()},e.prevView=function(){e.lop="#"+o.prevLoc(),i.unset()},e.saveUser=function(){var e=t.path();("/profil"==e||"/profil/1"==e||"/profil/2"==e)&&n.save(),"/declaration/map"==e&&n.savePosition(),"/declaration/dessin"==e&&(navigator.notification.confirm("Vous allez quittez la page, votre croquis ne pourra plus être modifier dans ce constat",function(){},"Attention","Continuer,Annuler"),n.saveCanvas()),"/declaration/2"==e&&n.saveVoletA(),"/declaration/3"==e&&n.saveVoletB(),"/declaration/1"==e&&n.saveDataDay(),"/declaration/circons"==e&&n.saveCircons()},e.apptitle="Constat d'accident",e.getCategory=function(){o.cat()},e.$watch(o.cat,function(t){e.apptitle=t}),$(".contextMenu ul").css({width:.9*$(window).width(),height:$(window).height()}),e.setTransition=function(){a.transite="active"}}]).controller("mapCtrl",["$scope","$location","$http","$rootScope","Dispatch","Loading",function(e,t,o,n,a,r){e.loadMap=function(){$("#gmap").width($(window).width()).height($(window).height()-48),e.gmap=L.map("gmap",{zoomControl:!1}),e.gMarker=L.marker("",{draggable:!0}),e.gPosition,r.set(),navigator.geolocation.getCurrentPosition(e.onSuccess,e.onErrors,{timeout:1e4,maximumAge:3e3,enableHighAccuracy:!0})},e.onSuccess=function(t){e.gPosition=L.latLng(t.coords.latitude,t.coords.longitude),e.gmap.panTo(e.gPosition),e.gmap.setZoom(17),L.tileLayer("http://{s}.tiles.mapbox.com/v3/roelensdam.idg4hnda/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://www.MapBox.com">MapBox</a>',maxZoom:18}).addTo(e.gmap),e.gMarker.setLatLng(e.gPosition),e.gMarker.addTo(e.gmap),r.unset()},e.onErrors=function(){navigator.geolocation.getCurrentPosition(e.onSuccess,e.onErrors2,{timeout:1e4,maximumAge:6e4,enableHighAccuracy:!1})},e.onErrors2=function(){r.unset(),navigator.notification.confirm("Votre position n'a pu être définie, veuillez vérifier votre paramètres Internet",e.callback,"Erreur","Réesayer,Annuler")},e.callback=function(o){1==o?(r.set(),navigator.geolocation.getCurrentPosition(e.onSuccess,e.onErrors,{timeout:1e4,maximumAge:6e4,enableHighAccuracy:!0})):e.$apply(t.path("/declaration/1"))},e.loadMap(),n.$on("savePosition",function(){n.position=e.gMarker.getLatLng();var t=function(i){o({method:"GET",url:"http://dev.virtualearth.net/REST/v1/Locations/"+n.position.lat+","+n.position.lng+"?o=json&key=AmYu1ctV5GfNllJLzLDKEaBAXHGvQrIYktr9aig6YEp2ZpAF9TIin2JECbp7WzdF",headers:{"Access-Control-Allow-Origin":"*"}}).success(function(t){e.temp=t.resourceSets[0].resources[0].name,a.put(e.temp),r.set()}).error(function(e,o){i>=5?navigator.notification.alert("Erreur de geocoding",null,o,"Ok"):(i+=1,t(i))})};t(1),n.$$listeners.savePosition=[]})}]).controller("positionCtrl",["$rootScope","$scope","Dispatch","Loading",function(e,t,o,n){var a;t.d=new Date,t.month=t.d.getMonth()+1,t.day=t.d.getDate(),t.year=t.d.getFullYear(),t.hours=t.d.getHours(),t.minutes=t.d.getMinutes(),t.yo=o.get();var r=t.$watch(o.get,function(e,o){return 1==a&&n.unset(),e===o?(a=!0,void 0):(t.pos=e,r(),void 0)});t.heure=(t.hours<10?"0"+t.hours:t.hours)+":"+(t.minutes<10?"0"+t.minutes:t.minutes),t.jour=(t.day<10?"0"+t.day:t.day)+"/"+(t.month<10?"0"+t.month:t.month)+"/"+t.year,window.sessionStorage.getItem("dataday"),e.$on("saveDataDay",function(){var o={position:t.pos,heure:t.heure,jour:t.jour};window.sessionStorage.setItem("dataday",JSON.stringify(o)),e.$$listeners.saveDataDay=[]})}]).controller("choiceCtrl",["$rootScope","$scope",function(e,t){t.setTransition=function(){e.transite="active"}}]).controller("profilCtrl",["$scope","$rootScope","$location","Context",function(e,t){if(window.localStorage.getItem("dataUser")){var o=JSON.parse(window.localStorage.getItem("dataUser"));e.name=o.nom,e.surname=o.prenom,e.street=o.adresse,e.postal=o.code,e.land=o.pays,e.tel=o.tel,e.email=o.email}if(window.localStorage.getItem("dataCar")){var n=JSON.parse(window.localStorage.getItem("dataCar"));e.car=n.marque,e.ni=n.ni,e.pi=n.pi}if(window.localStorage.getItem("dataAss")){var a=JSON.parse(window.localStorage.getItem("dataAss"));e.assname=a.nom,e.ncontrat=a.contrat,e.ncarte=a.carte,e.agence=a.agence,e.assadress=a.adresse,e.asstel=a.tel}t.$on("saveUser",function(){var o={nom:e.name,prenom:e.surname,adresse:e.street,code:e.postal,pays:e.land,tel:e.tel,email:e.email};window.localStorage.setItem("dataUser",JSON.stringify(o));var n={marque:e.car,ni:e.ni,pi:e.pi};window.localStorage.setItem("dataCar",JSON.stringify(n));var a={nom:e.assname,contrat:e.ncontrat,carte:e.ncarte,agence:e.agence,adresse:e.assadress,tel:e.asstel};window.localStorage.setItem("dataAss",JSON.stringify(a)),window.plugins.toast.show("Profil sauvegardé!","short","bottom"),t.$$listeners.saveUser=[]})}]).controller("menuCtrl",["$scope","$rootScope",function(e,t){setTimeout(function(){$(".overlay").hide()},1e3),e.toggleAbout=function(){$(".overlay").is(":visible")?$(".overlay").fadeOut(200):$(".overlay").fadeIn(200)},e.setTransition=function(){t.transite="active"}}]).controller("swipeCtrl",["$scope","Context","$location","$swipe",function(e){e.getNextLoc=function(){},e.getPrevLoc=function(){}}]).controller("photoCtrl",["$scope","Loading",function(e,t){e.pictureSource=navigator.camera.PictureSourceType,e.destinationType=navigator.camera.DestinationType,e.photos=window.sessionStorage.getItem("photos")?JSON.parse(window.sessionStorage.getItem("photos")):[],e.browsePhoto=function(){t.set();var o=$("#photos img").length;return 3==o?(navigator.notification.alert("3 photos maximum !",null,status,"Ok"),void 0):(navigator.camera.getPicture(e.onPhotoURISuccess,e.onFail,{quality:80,destinationType:e.destinationType.DATA_URL,sourceType:e.pictureSource.PHOTOLIBRARY,correctOrientation:!0}),void 0)},e.launchPhoto=function(){t.set();var o=$("#photos img").length;return 3==o?(navigator.notification.alert("3 photos maximum !",null,status,"Ok"),void 0):(navigator.camera.getPicture(e.onPhotoDataSuccess,e.onFail,{quality:80,destinationType:e.destinationType.DATA_URL,correctOrientation:!0}),void 0)},e.onPhotoDataSuccess=function(o){var n=document.createElement("img");n.addEventListener("load",function(){var a=n.height/n.width,r=.875*$(window).width();e.$apply(e.photos.push({src:"data:image/jpeg;base64,"+o,width:r+"px",height:r*a+"px"})),t.unset(),window.sessionStorage.setItem("photos",JSON.stringify(e.photos))}),n.src="data:image/jpeg;base64,"+o},e.onPhotoURISuccess=function(o){var n=document.createElement("img");n.addEventListener("load",function(){var a=n.height/n.width,r=.875*$(window).width();e.$apply(e.photos.push({src:"data:image/jpeg;base64,"+o,width:r+"px",height:r*a+"px"})),t.unset(),window.sessionStorage.setItem("photos",JSON.stringify(e.photos))}),n.src="data:image/jpeg;base64,"+o},e.onFail=function(e){t.unset(),navigator.notification.alert("Failed because: "+e,null,status,"Ok")}}]).controller("assistCtrl",["$scope",function(e){e.numeros=[{nom:"Touring Mobilis",tel:"046568129"},{nom:"Axa assurance",tel:"074594545"}],e.urgences=[{nom:"Police",tel:"101"},{nom:"Urgence",tel:"112"},{nom:"Pompiers et ambulances",tel:"100"}],e.assurances=[{nom:"Ehtias Assistance",value:"ethias@mail.com",group:"Assurance"},{nom:"Europ Assistance",value:"europ@mail.com",group:"Assurance"},{nom:"Belfius Assistance",value:"belfius@mail.com",group:"Assurance"}]}]).controller("circonsCtrl",["$scope","$rootScope",function(e,t){e.Uid=0,e.tem,e.temoin,e.checke1,e.checke2,e.checke3,e.addNewTem=function(){e.Uid=e.Uid+1,e.tem||(e.tem=[]),e.tem.push({Uid:e.Uid,name:e.temname,adress:e.temsurname,tele:e.temadress})},e.deleteMe=function(t){for(var o=0;o<=e.tem.length;o++)e.tem[o].Uid==t&&e.tem.splice(o,1);0==e.tem.length&&(e.tem=void 0)},window.sessionStorage.getItem("circons")&&JSON.parse(window.sessionStorage.getItem("circons")),t.$on("saveCircons",function(){console.log("event");var o={presencetemoin:e.temoin,temoins:e.tem,autresparties:e.checke2,blesses:e.checke1,autresdegats:e.checke3};console.log(o),window.sessionStorage.setItem("circons",JSON.stringify(o)),t.$$listeners.saveCircons=[]})}]).controller("voletaCtrl",["$scope","$rootScope",function(e,t){if(window.localStorage.getItem("dataUser")){var o=JSON.parse(window.localStorage.getItem("dataUser"));e.name=o.nom,e.surname=o.prenom,e.street=o.adresse,e.postal=o.code,e.land=o.pays,e.tel=o.tel,e.email=o.email}if(window.localStorage.getItem("dataCar")){var n=JSON.parse(window.localStorage.getItem("dataCar"));e.car=n.marque,e.ni=n.ni,e.pi=n.pi}if(window.localStorage.getItem("dataAss")){var a=JSON.parse(window.localStorage.getItem("dataAss"));e.assname=a.nom,e.ncontrat=a.contrat,e.ncarte=a.carte,e.agence=a.agence,e.assadress=a.adresse,e.asstel=a.tel}window.sessionStorage.getItem("voleta"),t.$on("saveVoletA",function(){window.sessionStorage.setItem("voleta",""),t.$$listeners.saveVoletA=[]})}]).controller("voletbCtrl",["$scope","$rootScope",function(e,t){window.sessionStorage.getItem("voletb"),t.$on("saveVoletB",function(){window.sessionStorage.setItem("voletb",""),t.$$listeners.saveVoletB=[]})}]).controller("recapCtrl",["$scope","$location",function(e,t){var o=t.path();if("/declaration/recap1"==o){var n=JSON.parse(window.sessionStorage.getItem("dataday")),a=JSON.parse(window.sessionStorage.getItem("circons"));console.log(a),e.date=n.jour,e.heure=n.heure,e.posi=n.position,e.temoi=a.presencetemoin,e.bless=a.blesses,e.vehic=a.autresparties,e.dega=a.autresdegats}"/declaration/recap2"==t.path()&&window.sessionStorage.getItem(""),"/declaration/recap3"==t.path()&&(console.log(window.sessionStorage.getItem("croquis")),e.croquis=window.sessionStorage.getItem("croquis"))}]).controller("confirmCtrl",["$scope",function(e){e.toolPeny=function(){var t=window.sessionStorage.getItem("croquis");e.mailto=window.sessionStorage.getItem("dataUser").email;var o=$.ajax({url:"http://www.damien-roelens.be/Constat/constat.php",type:"post",data:{data:t,email:e.mailto}});o.done(function(e,t){Console.log("Envoi du constat éffectué!"+e+" "+t),navigator.notification.alert("Envoi du constat éffectué!"+e+" "+t,null,status,"Ok")})}}]).controller("dessinCtrl",["$scope","Dessins","$rootScope","$location",function(e,t,o){e.moving=!0,e.scaling=!1,e.draw=function(){function n(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function a(e){return e%2}function r(e){for(var t=/[+-]?\d+\.\d+/g,o=e.match(t).map(function(e){return parseFloat(e)}),n=99999,r=-99999,i=99999,s=-99999,l=0;l<o.length;l++)a(l)?(o[l]<i&&(i=o[l]),o[l]>s&&(s=o[l])):(o[l]<n&&(n=o[l]),o[l]>r&&(r=o[l]));return{minX:n,minY:i,maxX:r,maxY:s}}function i(e){if(e.target.attrs.name)"deletition"==e.target.attrs.name&&(e.target.getParent().remove(),window.plugins.toast.show("Objet supprimé","short","bottom")),"layerplus"==e.target.attrs.name&&(e.target.getParent().moveUp(),window.plugins.toast.show("Calque supérieur","short","bottom")),"layermin"==e.target.attrs.name&&(e.target.getParent().moveDown(),window.plugins.toast.show("Calque inférieur","short","bottom"));else if(void 0!==l?(e.target!==l&&(l.getParent().children[0].stroke("transparent"),l.getParent().children[1].stroke("transparent"),l.getParent().children[2].stroke("transparent"),l.getParent().children[3].stroke("transparent"),l.getParent().children[1].fill("transparent"),l.getParent().children[2].fill("transparent"),l.getParent().children[3].fill("transparent"),l.getParent().draggable(!1),l.eventListeners.touchmove=[],d=!0),e.target._id==l._id&&(l.getParent().children[0].stroke("transparent"),l.getParent().children[1].stroke("transparent"),l.getParent().children[2].stroke("transparent"),l.getParent().children[3].stroke("transparent"),l.getParent().children[1].fill("transparent"),l.getParent().children[2].fill("transparent"),l.getParent().children[3].fill("transparent"),l.getParent().draggable(!1),l=void 0,d=!1)):d=!0,d){l=e.target;var t=l.getParent().children[0],o=l.getParent().children[1],n=l.getParent().children[2],a=l.getParent().children[3];l.getParent().draggable(!0),t.stroke("blue"),o.stroke("black"),n.stroke("black"),a.stroke("black"),o.fill("white"),n.fill("white"),a.fill("white");var i=r(l.getAttrs().sceneFunc.toString());t.width(i.maxX+10),t.height(i.maxY+10),t.offset({x:5,y:5}),t.lineCap("round"),t.strokeWidth("5")}u.draw()}function s(t){if(1==e.scaling){l.getParent().draggable(!1);var o=t.touches[0],a=t.touches[1];if(o&&a){var r=n({x:o.clientX,y:o.clientY},{x:a.clientX,y:a.clientY});c||(c=r);var i={x:l.getParent().scale().x*r/c,y:l.getParent().scale().y*r/c};l.getParent().scale(i),u.draw(),c=r}}1==e.moving&&l.getParent().draggable(!0)}var l,c=0,g=null,u=null,d=!1,p=$(window).height()-100,m=$(window).width()-2;$("#croquis").height(p),g=new Kinetic.Stage({container:"croquis",width:m,height:p}),u=new Kinetic.Layer,e.rotePos=function(){if(l){var e=l.getParent().rotation();l.getParent().rotation(e+10),u.draw()}else window.plugins.toast.show("Choisissez une forme d'abord !","short","bottom")},e.roteNeg=function(){if(l){var e=l.getParent().rotation();l.getParent().rotation(e-10),u.draw()}else window.plugins.toast.show("Choisissez une forme d'abord !","short","bottom")},e.transit=function(){1==e.scaling?(e.scaling=!1,e.moving=!0,window.plugins.toast.show("Déplacement activé","short","bottom")):(e.scaling=!0,e.moving=!1,window.plugins.toast.show("Mise à échelle activé","short","bottom"))},e.addObject=function(e){var o=new Kinetic.Group({x:0,y:0,dragBoundFunc:function(e){if(e.y<0)var t=0;else if(e.y>p)var t=p;else var t=e.y;if(e.x<0)var o=0;else if(e.x>m)var o=m;else var o=e.x;return{x:o,y:t}},rotation:0,offset:{x:0,y:0}}),n=new Kinetic.Shape({x:0,y:0,sceneFunc:t.get(e),fill:t.getColor(e),stroke:"black",offset:{x:0,y:0}}),a=new Kinetic.Shape({x:0,y:0,sceneFunc:function(e){e.beginPath(),e.moveTo(31,16),e.bezierCurveTo(31,7.7,24.3,1,16,1),e.bezierCurveTo(7.7,1,1,7.7,1,16),e.bezierCurveTo(1,24.3,7.7,31,16,31),e.bezierCurveTo(24.3,31,31,24.3,31,16),e.closePath(),e.fillStrokeShape(this),e.stroke(),e.beginPath(),e.moveTo(23.2,9.4),e.lineTo(8.8,23.7),e.stroke(),e.beginPath(),e.moveTo(8.8,9.4),e.lineTo(23.2,23.7),e.stroke()},fill:"transparent",stroke:"transparent",offset:{x:25,y:30},name:"deletition"}),r=new Kinetic.Shape({x:0,y:0,sceneFunc:function(e){e.beginPath(),e.moveTo(31,16),e.bezierCurveTo(31,7.7,24.3,1,16,1),e.bezierCurveTo(7.7,1,1,7.7,1,16),e.bezierCurveTo(1,24.3,7.7,31,16,31),e.bezierCurveTo(24.3,31,31,24.3,31,16),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,14.4),e.lineTo(6.5,20.1),e.lineTo(16.4,26.6),e.lineTo(26.4,20.1),e.lineTo(16.4,14.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,10.4),e.lineTo(6.5,16.1),e.lineTo(16.4,22.6),e.lineTo(26.4,16.1),e.lineTo(16.4,10.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,6.4),e.lineTo(6.5,12.1),e.lineTo(16.4,18.6),e.lineTo(26.4,12.1),e.lineTo(16.4,6.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(18.7,11.5),e.lineTo(13.7,11.5),e.stroke(),e.beginPath(),e.moveTo(16.2,14),e.lineTo(16.2,9),e.stroke()},fill:"transparent",stroke:"transparent",offset:{x:-25,y:30},name:"layerplus"}),i=new Kinetic.Shape({x:0,y:0,sceneFunc:function(e){e.beginPath(),e.moveTo(31,16),e.bezierCurveTo(31,7.7,24.3,1,16,1),e.bezierCurveTo(7.7,1,1,7.7,1,16),e.bezierCurveTo(1,24.3,7.7,31,16,31),e.bezierCurveTo(24.3,31,31,24.3,31,16),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,14.4),e.lineTo(6.5,20.1),e.lineTo(16.4,26.6),e.lineTo(26.4,20.1),e.lineTo(16.4,14.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,10.4),e.lineTo(6.5,16.1),e.lineTo(16.4,22.6),e.lineTo(26.4,16.1),e.lineTo(16.4,10.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(16.4,6.4),e.lineTo(6.5,12.1),e.lineTo(16.4,18.6),e.lineTo(26.4,12.1),e.lineTo(16.4,6.4),e.closePath(),e.fillStrokeShape(this),e.beginPath(),e.moveTo(18.7,11.5),e.lineTo(13.7,11.5),e.stroke()},fill:"transparent",stroke:"transparent",offset:{x:-75,y:30},name:"layermin"}),s=new Kinetic.Rect({x:0,y:0,width:50,height:50,fill:"transparent",stroke:"transparent",offset:{x:0,y:0}});o.add(s,a,r,i,n),u.add(o),u.draw()},g.add(u),g.draw(),u.on("tap",function(e){i(e),l&&(l.getParent().addEventListener("touchmove",s),l.getParent().addEventListener("touchend",function(){c=0},!1))}),o.$on("saveCanvas",function(){l&&(l.getParent().children[0].stroke("transparent"),l.getParent().children[1].stroke("transparent"),l.getParent().children[2].stroke("transparent"),l.getParent().children[3].stroke("transparent"),l.getParent().children[1].fill("transparent"),l.getParent().children[2].fill("transparent"),l.getParent().children[3].fill("transparent"),l.getParent().draggable(!1),l=void 0),g.toDataURL({callback:function(e){window.sessionStorage.setItem("croquis",e)}}),o.$$listeners.saveCanvas=[]})},e.draw()}]);